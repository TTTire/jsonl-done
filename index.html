<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSONL 文件处理器</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Ctext x='12' y='18' font-family='Arial, sans-serif' font-size='20' font-weight='bold' text-anchor='middle'%3EZ%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .left-label, .right-label {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            font-size: 72px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.6);
            writing-mode: vertical-rl;
            text-orientation: mixed;
            z-index: 1000;
            pointer-events: none;
            animation: float 3s ease-in-out infinite;
            transition: all 0.3s ease;
        }
        
        .left-label {
            left: 60px;
            animation-delay: 0s;
        }
        
        .right-label {
            right: 60px;
            animation-delay: 1.5s;
        }
        
        .left-label:hover, .right-label:hover {
            transform: translateY(-50%) scale(1.1);
            color: rgba(255, 255, 255, 1);
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.8);
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(-50%) translateX(0px);
            }
            50% {
                transform: translateY(-50%) translateX(10px);
            }
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }
        .input-group {
            margin-bottom: 25px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }
        input[type="file"], input[type="text"], input[type="number"], input[type="date"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        input[type="file"] {
            background: #f8f9fa;
            cursor: pointer;
        }
        input[type="file"]:hover {
            background: #e9ecef;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #statusArea {
            margin-top: 25px;
            padding: 15px;
            border-radius: 8px;
            min-height: 60px;
            text-align: left;
            font-size: 14px;
            line-height: 1.5;
        }
        .status-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1976d2;
        }
        .status-success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }
        .status-error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }
        .file-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>JSONL 文件处理器</h1>
        
        <div class="input-group">
            <label for="fileInput">选择 JSONL 文件：</label>
            <input type="file" id="fileInput" accept=".jsonl" />
        </div>

        <div class="input-group">
            <label for="dateInput">当前日期：</label>
            <input type="date" id="dateInput" />
        </div>

        <div class="input-group">
            <label for="splitCountInput">每份文件的行数：</label>
            <input type="number" id="splitCountInput" placeholder="每份文件的行数..." min="1" />
        </div>

        <button id="processButton">处理并下载</button>

        <div id="statusArea"></div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dateInput = document.getElementById('dateInput');
        const splitCountInput = document.getElementById('splitCountInput');
        const processButton = document.getElementById('processButton');
        const statusArea = document.getElementById('statusArea');

        function showStatus(message, type = 'info') {
            statusArea.className = `status-${type}`;
            statusArea.innerHTML = message;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function generateUUID() {
            if (crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function downloadFile(content, fileName) {
            const blob = new Blob([content], { type: 'application/jsonl' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function chunkArray(array, chunkSize) {
            const chunks = [];
            for (let i = 0; i < array.length; i += chunkSize) {
                chunks.push(array.slice(i, i + chunkSize));
            }
            return chunks;
        }

        async function processFile() {
            try {
                const file = fileInput.files[0];
                if (!file) {
                    showStatus('请选择一个JSONL文件', 'error');
                    return;
                }

                const userDate = dateInput.value;
                if (!userDate) {
                    showStatus('请选择日期', 'error');
                    return;
                }

                const splitCount = parseInt(splitCountInput.value);
                if (!splitCount || splitCount < 1) {
                    showStatus('请输入有效的切分行数（必须大于0）', 'error');
                    return;
                }

                processButton.disabled = true;
                processButton.textContent = '处理中...';

                showStatus('正在读取文件...', 'info');

                const fileContent = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('文件读取失败'));
                    reader.readAsText(file);
                });

                showStatus('正在解析文件内容...', 'info');

                const lines = fileContent.split('\n').filter(line => line.trim());
                const jsonObjects = [];
                
                for (let i = 0; i < lines.length; i++) {
                    try {
                        const obj = JSON.parse(lines[i]);
                        jsonObjects.push(obj);
                    } catch (error) {
                        showStatus(`第 ${i + 1} 行JSON解析失败: ${error.message}`, 'error');
                        return;
                    }
                }

                showStatus(`成功解析 ${jsonObjects.length} 行数据，正在处理...`, 'info');

                const currentDate = formatDate(userDate);

                const processedObjects = jsonObjects.map(obj => {
                    // 在最后一个下划线前面插入用户选择的日期
                    const originalInternalId = obj['internal_id'] || 'unknown';
                    
                    let newInternalId;
                    if (originalInternalId !== 'unknown') {
                        // 找到最后一个下划线的位置
                        const lastUnderscoreIndex = originalInternalId.lastIndexOf('_');
                        
                        if (lastUnderscoreIndex !== -1) {
                            // 在最后一个下划线前面插入日期
                            const beforeLastUnderscore = originalInternalId.substring(0, lastUnderscoreIndex);
                            const afterLastUnderscore = originalInternalId.substring(lastUnderscoreIndex);
                            newInternalId = `${beforeLastUnderscore}_${currentDate}${afterLastUnderscore}`;
                        } else {
                            // 没有下划线，直接在末尾添加日期
                            newInternalId = `${originalInternalId}_${currentDate}`;
                        }
                    } else {
                        // 如果原始internal_id是unknown，直接使用新日期
                        newInternalId = `unknown_${currentDate}`;
                    }
                    
                    const newObj = { ...obj };
                    newObj['internal_id'] = newInternalId;
                    
                    // 添加reference字段，包含prompt的全部内容
                    if (obj.prompt) {
                        newObj.reference = obj.prompt;
                    } else {
                        newObj.reference = '';
                    }
                    
                    // 截断prompt字段，只保留前10个字符
                    if (obj.prompt) {
                        newObj.prompt = obj.prompt.substring(0, 10);
                    }
                    
                    return newObj;
                });

                showStatus('数据处理完成，正在切分文件...', 'info');

                const chunks = chunkArray(processedObjects, splitCount);
                const totalFiles = chunks.length;

                showStatus(`文件切分完成，共 ${totalFiles} 个文件，正在准备下载...`, 'info');

                for (let i = 0; i < chunks.length; i++) {
                    const chunk = chunks[i];
                    // 使用原始文件名作为基础，格式为：{原始文件名}_part_{序号}.jsonl
                    const originalFileName = file.name.replace('.jsonl', '');
                    const fileName = `${originalFileName}_part_${i + 1}.jsonl`;
                    
                    const jsonlContent = chunk.map(obj => JSON.stringify(obj)).join('\n');
                    
                    downloadFile(jsonlContent, fileName);
                    
                    showStatus(`正在下载第 ${i + 1}/${totalFiles} 个文件: ${fileName}`, 'info');
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                showStatus(`处理完成！成功生成并下载了 ${totalFiles} 个文件。`, 'success');
                
                const fileInfo = `
                    <div class="file-info">
                        <strong>处理摘要：</strong><br>
                        • 原始文件：${file.name}<br>
                        • 总行数：${jsonObjects.length}<br>
                        • 切分数量：${splitCount} 行/文件<br>
                        • 生成文件：${totalFiles} 个<br>
                        • 处理日期：${currentDate}<br>
                        • 处理说明：每行internal_id已在最后一个下划线前插入{用户选择日期}，prompt字段截断为前10字符，reference字段保存prompt的完整内容
                    </div>
                `;
                statusArea.innerHTML += fileInfo;

            } catch (error) {
                showStatus(`处理过程中发生错误: ${error.message}`, 'error');
                console.error('Error:', error);
            } finally {
                processButton.disabled = false;
                processButton.textContent = '处理并下载';
            }
        }

        processButton.addEventListener('click', processFile);

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                showStatus(`已选择文件: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'info');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            
            showStatus('请选择JSONL文件，选择日期，设置切分行数，然后点击"处理并下载"按钮。', 'info');
        });
    </script>
</body>
</html>
